# Powerful Design Patterns

- 참조 다이어그램
  - `11.drawio`

## 설계방안 (입문)

어떻게 풀어나가면 좋을까?

1. 만들려는 e커머스 앱에 대해 깊게 생각해본다.
1. 레디스에 어떻게 넣어야 적재적소에 쓰이는 것인지 설계한다.
1. (캐시처럼 쓸거면) 무슨 데이터를 해시처럼 쓸지 정한다
1. 코드작성!

## 설계방안 (1) 경매 규칙

1. "유저"는 "아이템"을 팔기 위해 생성한다.
1. 아이템은 시작가와 입찰종료 시간이 있다
1. 다른 "유저"는 "아이템"에 "입찰"할 수 있다. "입찰"은 기존 가격보다 높아야한다
1. 입찰종료 시간이 지나면 가장 높은 "입찰"을 한 유저가 가진다.

## 설계방안 (2) 상세

1. 파일에 상세히 써져있다.
   1. '어떤 화면에선 뭐가 필요하고, 어떤걸 해야한다' 류의 그림...
1. 난 백엔드 파트니까...
   1. 구성 쌓아올리기
      1. 나온 도메인들을 어떻게 추려낼지 고민하고, 도메인부터 테스트하고
      1. 어떤 영속적 저장소에 관리할지 생각해보고
      1. 어떤 비즈니스 로직이 있는지 고려 후 껍데기를 만들어서 지속적으로 테스트하고
      1. 그걸 표현하기 위한 API 엔드포인트가 뭐가 필요한지 파악 후 테스트하고
   1. 추가 고민
      1. 어디에 어떤 권한이 필요할 지 고려하고
      1. 어떤 도메인이 추가로 붙고 떨어지는지에 대해 고민해보고
      1. 데브옵스 환경으로 배포하려면 뭐가 중요한지 생각해보고

사실 다 제치고 '백엔드 파트 > 구성 쌓아올리기' 자체를 못하면 의미가 없다. 이 것부터 잘 하고 점차점차 확장해나가자고.

## 쿼리를 최소한으로 해보자!

### SQL DB 디자인 방법론

1. 데이터를 테이블에 넣는다
1. 어떻게 쿼리할지 구상한다

### 레디스 디자인 방법론

1. 무슨 쿼리를 풀어야할지 생각한다
1. 해당 쿼리에 대한 최적의 데이터 구조를 구상한다

## 이걸 어떻게 접근 해볼까요? (1)

1. 어떤 "엔티티"가 있는지 살펴볼 수 있다
1. 읽기/쓰기 과정을 나눌 수 있다
1. 그렇다면, 어떤 쿼리 혹은 데이터 변화가 각 페이지에 필요한가 살펴보자.
   1. 리스트 페이지
      1. 가격별 아이템
      1. ending time에 대한 아이템
      1. most views에 대한 아이템
   1. 로그인 페이지
      1. 유저에 대한 권한
      1. 세션 생성, 검색, 유저별 세션정보 (auth)
   1. 아이템 조회
      1. "좋아요" 표시 및 각종 정보들
   1. 유저별 아이템 조회
      1. "유저별" "좋아요" 표시 및 각종 정보들
   1. 테이블
1. 구현해야 할 전체 정보를 리스트업 할 수 있다

> 이 것들을 토대로 뭘 해시처럼 저장할 수 있는지 파악해보자

## 이걸 어떻게 접근해볼까요? (2)

어떤 데이터를 해시처럼 저장할 수 있을까?

1. 되는 것
   - 많은 속성을 가진 레코드
   - 여러 방법으로 정렬된 레코드 컬렉션
   - 가끔씩 개별 레코드에 접근해야 할 필요가 있는 경우
1. 쓰면 안될 것 같은 것
   - 갯수를 세거나 유일성이 반드시 필요한 레코드
   - 하나, 둘 정도만 갖고있는 레코드
   - 두 레코드 사이에 관계를 생성하는데만 쓰이는 경우
   - 데이터 시계열처리에만 필요한 레코드

이걸 토대로 상기 엔티티들 중 캐시처리할 것을 정한다.

1. 해시처리할 값들
   - 세션
   - 유저정보
   - 아이템
1. 곤란한 것들
   - bids
   - likes
   - views

## 캐시 구현 (1) : 유저

키값의 prefix 정하기

- 레디스에 쉽게 접근하기 위해?
  - `pagecache#{id}`
- 유저 캐시 -> 이걸 통해서 k, v형식의 데이터로 접근
  - `users#{unique_id}`
- 유저 생성 시, `HSET` 으로 유저 키/밸류를 저장 (물론 실무에선 쌩으로 플레인텍스트를 담진 않을 것. 아이디어만 캐치하시오)

## 캐시 구현 (2) : 직렬화/역직렬화

- Company 정보를 캐시처리할 때?
  - 해시값으로 키를 쓸건데 ID를 중복해서 넣을 필요는 없다!
  - 날짜값은 포맷이 필요할 듯?
    - 이런건 **직렬화**
- Company 정보를 갖고올 때?
  - 음, ID가 필요할 것 같다...
  - 몇몇 값은 "문자열" 대신 "숫자", "날짜"타입 이었으면 좋겠다
    - 이런건 Company 정보에 대해 미리 갖고있다가 필요하면 **역직렬화**

## 캐시 구현 (3) : 세션

세션을 정말 간단하게 구현해보자!

- (1) 유저 편에서 유저를 생성하고난 후...
- 세션 토큰이란 걸 만들고 랜덤하게 ID/PW에 대한 세션을 유지
- 브라우저한테 세션 토큰 전달 → 다음부턴 이걸 담고 호출하시오

주요아이디어를 구현하는 코드(TS로 짬)

1. 몇몇 주요값(생성, 만료일자)을 객체로 직렬화한다
2. 그 값을 `HSET` 으로 저장한다

- `sessions#${sessionId}`
- `items#${itemId}`

## 캐시 구현 (4) : 값 가져오기(fetching)

값을 넣었으면 꺼내쓸 수도 있어야한다.

1. `HGETALL` 을 하기 위해 ID값을 넣고 요청한다.
   2.1. 응답받은 값이 `null` 이면 아무것도 안 한다.
   2.2. 응답받은 값 중 필요한 값은 역직렬화(deserialize) 한다.

- 인메모리 DB에 넣을땐 객체를 바로 집어넣는다
- 인메모리 DB에서 꺼낸후 전달할 땐 사람이 알아볼 수 있는(혹은 전달받는 사람과 맞는 규격의) 데이터를 전달한다
